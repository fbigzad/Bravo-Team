{% extends "main/base.html" %}

{% block title %}Weekly Calendar{% endblock %}

{% block content %}
  <h2>Your Weekly Schedule</h2>

  <!-- =========================
       Weekly Navigation
       ========================= -->
  <div class="calendar-nav">
    <a class="btn btn-soft" href="{% url 'calendar_weekly' %}?start={{ prev_start|date:'Y-m-d' }}">← Previous Week</a>
    <a class="btn btn-soft" href="{% url 'calendar_weekly' %}?start={{ next_start|date:'Y-m-d' }}">Next Week →</a>

    <!-- Jump to monthly for the same month as week_start -->
    <a class="btn btn-outline" href="{% url 'calendar_monthly' %}?year={{ week_start|date:'Y' }}&month={{ week_start|date:'n' }}">Monthly View</a>
  </div>

  <p class="muted">Week: {{ week_start|date:"M d, Y" }} to {{ week_end|date:"M d, Y" }}</p>

  <section class="dash-card weekly-calendar-section">
    <div class="calendar-wrapper">
      <table class="calendar-table weekly">
        <thead>
          <tr>
            <th>Time</th>
            {% for d in week_days %}
              <th>
                {{ d|date:"D" }}<br>
                <span class="muted">{{ d|date:"m/d" }}</span>
              </th>
            {% endfor %}
          </tr>
        </thead>

        <tbody>
          {# 24 hours: table_rows should be built as 0..23 in the view #}
          {% for row in table_rows %}
            <tr>
              <td class="time-col">{{ row.hour|stringformat:"02d" }}:00</td>

              {% for cell in row.cells %}
                <td>
                  {% if cell.items %}
                    {% for item in cell.items %}

                      {# CLICKABLE EVENT: opens detail page, returns back to this week #}
                      <a class="event-link"
                         href="{% url 'schedule_detail' item.pk %}?next={{ request.get_full_path|urlencode }}">
                        <div class="event">
                          <strong>{{ item.title }}</strong>
                          <span class="pill">{{ item.get_item_type_display }}</span>
                          <div class="muted">{{ item.time|time:"H:i" }} ({{ item.duration_minutes }} min)</div>
                          {% if item.notes %}
                            <div class="muted">{{ item.notes }}</div>
                          {% endif %}
                        </div>
                      </a>

                    {% endfor %}
                  {% else %}
                    <span class="muted">—</span>
                  {% endif %}
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>

      </table>
    </div>

    <p class="weekly-table-footer">
      <a href="{% url 'dashboard' %}">Back to Dashboard</a>
    </p>
  </section>
{% endblock %}
